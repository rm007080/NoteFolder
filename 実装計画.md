# 詳細実装計画：NoteFolder（修正版 v3）

> **更新履歴**:
> - 2025-12-26 v2: Codexレビューに基づき重大な問題を修正
> - 2025-12-26 v3: Codex再レビューに基づきAPI呼び出しとエラーハンドリングを修正

---

## 0. 修正サマリ

### v2での修正（完了）

| # | 問題 | 分類 | 修正内容 |
|---|------|------|----------|
| 1 | `tabs`権限不足 | **P0** | manifest.jsonに`tabs`権限を追加 |
| 2 | storage 8KB制限超過 | **P0** | プロジェクトごとに個別キーで保存する設計に変更 |
| 3 | 書き込みクォータ超過 | **P1** | 変更されたプロジェクトのみ書き込む |
| 4 | XSS脆弱性 | **P1** | `textContent`使用を必須化、`innerHTML`禁止 |
| 5 | URL解析の脆弱性 | **P1** | `new URL()`でホスト名を厳密検証 |
| 6 | タグ削除フロー欠落 | **P2** | 削除フローをセクション4.4に追加 |
| 7 | ストレージ初期化 | **P2** | デフォルト値による防御的読み込み |
| 8 | allTags重複・ソート | **P2** | 保存前に重複排除とソートを実施 |

### v3での修正（今回）

| # | 問題 | 分類 | 修正内容 |
|---|------|------|----------|
| 9 | `chrome.storage.sync.get`のAPIシグネチャが不正 | **P0** | 第1引数にデフォルト値オブジェクト、第2引数にコールバック |
| 10 | `chrome.runtime.lastError`チェックがない | **P1** | 全storage操作にエラーハンドリング追加（§6.3） |
| 11 | `normalizeAllTags`実行タイミングが不明確 | **P2** | 読み込み直後と保存前の両方で実行を明記（§6.2） |

---

## 1. 技術仕様

### Manifest V3 設定

```json
{
  "manifest_version": 3,
  "name": "NoteFolder",
  "version": "1.0.0",
  "description": "NotebookLMのプロジェクトをタグで管理する",
  "permissions": ["storage", "activeTab", "tabs"],
  "host_permissions": ["https://notebooklm.google.com/*"],
  "action": {
    "default_popup": "popup/popup.html",
    "default_icon": {
      "16": "icons/icon16.png",
      "48": "icons/icon48.png",
      "128": "icons/icon128.png"
    }
  },
  "icons": {
    "16": "icons/icon16.png",
    "48": "icons/icon48.png",
    "128": "icons/icon128.png"
  }
}
```

### 権限の根拠

| 権限 | 理由 | 備考 |
|------|------|------|
| `storage` | `chrome.storage.sync` でタグデータを保存・同期 | |
| `activeTab` | ポップアップ起動時に現在タブのURLを取得 | |
| `tabs` | `chrome.tabs.query()` でアクティブタブ情報を取得 | **v2 P0修正で追加** |
| `host_permissions` | NotebookLMドメインでのみURL取得を許可 | |

---

## 2. データ構造設計

### 2.1 ストレージスキーマ（個別キー方式）

**v2 P0修正**: プロジェクトごとに個別キーで保存。

```javascript
// 保存形式（chrome.storage.sync）
{
  // プロジェクトごとに個別キー（8KB制限を回避）
  "project:abc123def456": {
    "id": "abc123def456",
    "name": "プロジェクト名（任意）",
    "tags": ["AI", "学習"],
    "updatedAt": 1703123456789
  },
  "project:xyz789ghi012": {
    "id": "xyz789ghi012",
    "name": "別のプロジェクト",
    "tags": ["リサーチ"],
    "updatedAt": 1703123456000
  },

  // 使用済みタグ一覧（入力候補用・ソート済み）
  "allTags": ["AI", "リサーチ", "仕事", "個人", "学習"]
}
```

### 2.2 キー命名規則

| キー | 説明 | サイズ見込み |
|------|------|--------------|
| `project:{id}` | 個別プロジェクトデータ | 約100-200バイト/件 |
| `allTags` | 全タグ一覧（ソート済み） | 最大2KB想定 |

### 2.3 sync storage制限と対策

| 制約 | 値 | 対策 |
|------|----|----|
| 総容量 | 約102KB | 個別キー方式で分散保存 |
| 1アイテム上限 | 8,192バイト | 1プロジェクト = 1キーで確実に回避 |
| キー数上限 | 512個 | 約500プロジェクトまで対応可能 |
| 書き込み頻度 | 最大120回/分 | 変更分のみ書き込みで軽減 |

---

## 3. ファイル構成と役割

```
NoteFolder/
├── manifest.json           # 拡張定義（Manifest V3）
├── popup/
│   ├── popup.html          # ポップアップUI
│   ├── popup.css           # スタイル（〜100行）
│   └── popup.js            # UIロジック + Storage操作
├── icons/
│   ├── icon16.png
│   ├── icon48.png
│   └── icon128.png
├── 要件定義.md
├── 実装計画.md             # このファイル
├── アーキテクチャ.md
├── 参照ルール.md
└── CLAUDE.md
```

### 各ファイルの責務

| ファイル | 責務 |
|----------|------|
| `manifest.json` | 権限・popup・アイコン定義 |
| `popup.html` | UI構造（タグ入力、候補リスト、プロジェクト一覧） |
| `popup.css` | 最小限のスタイリング |
| `popup.js` | ① URL解析（安全な方式）<br>② タグ保存/読込（個別キー方式 + エラーハンドリング）<br>③ 候補表示<br>④ フィルタ表示<br>⑤ XSS対策 |

---

## 4. 主要処理フロー

### 4.1 ポップアップ起動時（v3修正）

```
popup.js 起動
    ↓
chrome.tabs.query({ active: true, currentWindow: true }, (tabs) => {
    ↓
extractProjectId(tabs[0].url) で安全にプロジェクトID抽出
    ├── 有効なID → ストレージから該当プロジェクトのタグを取得
    │               ↓
    │   【v3修正】正しいAPIシグネチャ:
    │   chrome.storage.sync.get(
    │     { [`project:${id}`]: null, allTags: [] },  // 第1引数: デフォルト値
    │     (result) => {                               // 第2引数: コールバック
    │       【v3修正】エラーチェック:
    │       if (chrome.runtime.lastError) {
    │         showError('データの読み込みに失敗しました');
    │         return;
    │       }
    │       // 正常時の処理...
    │       const allTags = normalizeAllTags(result.allTags); // 読み込み直後に正規化
    │     }
    │   )
    │
    └── null → 「NotebookLMのプロジェクトページを開いてください」
})
```

### 4.2 タグ追加フロー（v3修正）

```
タグ入力欄に入力
    ↓
入力中: allTags から前方一致で候補表示
    ↓
候補クリック or Enter
    ↓
バリデーション:
    - 空文字チェック
    - 重複チェック（既存タグと比較）
    ↓
【v3修正】正しいAPIシグネチャ:
chrome.storage.sync.get(
  { [`project:${id}`]: null, allTags: [] },  // 第1引数: デフォルト値オブジェクト
  (result) => {                               // 第2引数: コールバック
    【v3修正】エラーチェック:
    if (chrome.runtime.lastError) {
      showError('データの読み込みに失敗しました');
      return;
    }
    ↓
    該当プロジェクトにタグ追加:
        const project = result[`project:${id}`] || createNewProject(id);
        project.tags.push(newTag);
        project.updatedAt = Date.now();
    ↓
    【v3修正】allTags更新（正規化関数を使用）:
        let allTags = [...result.allTags, newTag];
        allTags = normalizeAllTags(allTags);  // 保存前に正規化
    ↓
    変更分のみ保存:
    chrome.storage.sync.set(
      { [`project:${id}`]: project, allTags: allTags },
      () => {
        【v3修正】エラーチェック:
        if (chrome.runtime.lastError) {
          showError('タグの追加に失敗しました');
          return;
        }
        // UI更新
      }
    )
  }
)
```

### 4.3 プロジェクトID抽出ロジック

```javascript
function extractProjectId(url) {
  try {
    const parsedUrl = new URL(url);

    // ホスト名を厳密にチェック
    if (parsedUrl.hostname !== 'notebooklm.google.com') {
      return null;
    }

    // パスから抽出
    const pathParts = parsedUrl.pathname.split('/');
    // 期待形式: /notebook/{projectId} または /notebook/{projectId}/...
    if (pathParts[1] === 'notebook' && pathParts[2]) {
      const id = pathParts[2];
      // 英数字、ハイフン、アンダースコアのみ許可
      if (/^[a-zA-Z0-9_-]+$/.test(id)) {
        return id;
      }
    }

    return null;
  } catch (e) {
    // 無効なURL
    return null;
  }
}
```

### 4.4 タグ削除フロー（v3修正）

```
ユーザーがタグバッジの「×」をクリック
    ↓
削除対象タグを特定
    ↓
【v3修正】正しいAPIシグネチャ:
chrome.storage.sync.get(
  { [`project:${id}`]: null },
  (result) => {
    【v3修正】エラーチェック:
    if (chrome.runtime.lastError) {
      showError('データの読み込みに失敗しました');
      return;
    }
    ↓
    project.tags から該当タグを削除:
        project.tags = project.tags.filter(t => t !== targetTag);
        project.updatedAt = Date.now();
    ↓
    chrome.storage.sync.set(
      { [`project:${id}`]: project },
      () => {
        【v3修正】エラーチェック:
        if (chrome.runtime.lastError) {
          showError('タグの削除に失敗しました');
          return;
        }
        // UI更新: タグバッジを再描画
      }
    )
  }
)

※ allTags からは削除しない（他プロジェクトで使用中の可能性）
※ 将来的に「未使用タグの一括削除」機能を検討
```

### 4.5 全プロジェクト取得フロー（v3修正）

```javascript
// 同一タグを持つプロジェクト一覧を表示するため
async function getAllProjects() {
  return new Promise((resolve, reject) => {
    chrome.storage.sync.get(null, (items) => {
      // 【v3修正】エラーチェック
      if (chrome.runtime.lastError) {
        reject(new Error(chrome.runtime.lastError.message));
        return;
      }

      const projects = [];
      for (const [key, value] of Object.entries(items)) {
        if (key.startsWith('project:')) {
          projects.push(value);
        }
      }
      resolve(projects);
    });
  });
}
```

---

## 5. セキュリティ対策

### 5.1 XSS対策（必須）

**禁止**: `innerHTML` でユーザー入力を挿入

```javascript
// ❌ 絶対禁止
element.innerHTML = tagName;

// ✅ 必須: textContentを使用
element.textContent = tagName;

// ✅ または createElement + appendChild
function createTagBadge(tagName) {
  const badge = document.createElement('span');
  badge.className = 'tag-badge';
  badge.textContent = tagName;

  const removeBtn = document.createElement('button');
  removeBtn.textContent = '×';
  removeBtn.addEventListener('click', () => removeTag(tagName));

  badge.appendChild(removeBtn);
  return badge;
}
```

### 5.2 入力バリデーション

```javascript
function validateTagName(tag) {
  // 空文字・空白のみは拒否
  if (!tag || !tag.trim()) {
    return { valid: false, error: 'タグ名を入力してください' };
  }

  // 最大長チェック（例: 50文字）
  if (tag.length > 50) {
    return { valid: false, error: 'タグ名は50文字以内にしてください' };
  }

  return { valid: true, tag: tag.trim() };
}
```

---

## 6. ストレージ操作のベストプラクティス

### 6.1 正しいAPIシグネチャ（v3 P0修正）

**❌ 誤ったAPIシグネチャ（動作しない）**:
```javascript
// MV3では第2引数はコールバック関数。オブジェクトを渡すとエラーになる
chrome.storage.sync.get(['key1', 'key2'], { key1: 'default' })
```

**✅ 正しいAPIシグネチャ**:
```javascript
// 第1引数: キー配列またはデフォルト値オブジェクト
// 第2引数: コールバック関数
chrome.storage.sync.get(
  {
    [`project:${projectId}`]: null,
    allTags: []
  },
  (result) => {
    // result にはデフォルト値またはストレージの値が入る
  }
);
```

### 6.2 allTagsの正規化（v3 P2修正）

```javascript
function normalizeAllTags(allTags) {
  // 重複排除 + ソート + 空文字除去
  return [...new Set(allTags)]
    .filter(tag => tag && tag.trim())
    .sort((a, b) => a.localeCompare(b, 'ja'));
}
```

**【v3修正】実行タイミング**:

| タイミング | 目的 | 呼び出し箇所 |
|------------|------|--------------|
| **読み込み直後** | 旧データのクリーンアップ | §4.1 ポップアップ起動時 |
| **保存前** | 新規追加時の正規化 | §4.2 タグ追加時 |

```javascript
// 読み込み直後に正規化（旧データ対応）
chrome.storage.sync.get({ allTags: [] }, (result) => {
  if (chrome.runtime.lastError) return;

  const normalizedTags = normalizeAllTags(result.allTags);

  // 正規化で変更があった場合のみ保存
  if (JSON.stringify(normalizedTags) !== JSON.stringify(result.allTags)) {
    chrome.storage.sync.set({ allTags: normalizedTags });
  }

  // 正規化済みのタグで候補表示
  displayTagSuggestions(normalizedTags);
});
```

### 6.3 エラーハンドリング（v3 P1追加）

**chrome.runtime.lastErrorを必ずチェックする**:

```javascript
// 読み込み時
chrome.storage.sync.get(defaults, (result) => {
  if (chrome.runtime.lastError) {
    console.error('Storage read error:', chrome.runtime.lastError.message);
    showError('データの読み込みに失敗しました');
    return;
  }
  // 正常時の処理
});

// 書き込み時
chrome.storage.sync.set(data, () => {
  if (chrome.runtime.lastError) {
    console.error('Storage write error:', chrome.runtime.lastError.message);
    showError('データの保存に失敗しました');
    return;
  }
  // 正常時の処理
});
```

**エラー表示ヘルパー関数**:

```javascript
function showError(message) {
  const errorArea = document.getElementById('error-area');
  errorArea.textContent = message;
  errorArea.style.display = 'block';

  // 5秒後に自動非表示
  setTimeout(() => {
    errorArea.style.display = 'none';
  }, 5000);
}
```

### 6.4 防御的な読み込み

```javascript
// デフォルト値を指定して null チェックを回避
chrome.storage.sync.get(
  {
    [`project:${projectId}`]: null,
    allTags: []
  },
  (result) => {
    if (chrome.runtime.lastError) {
      showError('データの読み込みに失敗しました');
      return;
    }

    const project = result[`project:${projectId}`] || {
      id: projectId,
      name: '',
      tags: [],
      updatedAt: Date.now()
    };
    const allTags = normalizeAllTags(result.allTags);
    // ...
  }
);
```

---

## 7. UI設計（ワイヤーフレーム）

```
┌─────────────────────────────────┐
│ 📓 NoteFolder                   │
├─────────────────────────────────┤
│ 現在のプロジェクト:              │
│ [ID: abc123def456]              │
├─────────────────────────────────┤
│ タグを追加:                      │
│ ┌─────────────────────┐ [追加]  │
│ │ 入力...             │         │
│ └─────────────────────┘         │
│ ┌─────────────────────┐         │
│ │ AI（候補）          │         │
│ │ 学習（候補）        │         │
│ └─────────────────────┘         │
├─────────────────────────────────┤
│ このプロジェクトのタグ:          │
│ [AI ×] [学習 ×]                 │  ← 削除可能
├─────────────────────────────────┤
│ 「AI」タグのプロジェクト:        │
│ • abc123def456 (現在)           │
│ • xyz789ghi012 → 開く           │
├─────────────────────────────────┤
│ ⚠️ エラーメッセージ表示エリア   │  ← v3追加: lastErrorを表示
└─────────────────────────────────┘
```

### エラー状態の表示

| 状態 | メッセージ | トリガー |
|------|------------|----------|
| NotebookLM以外 | 「NotebookLMのプロジェクトページを開いてください」 | extractProjectId() → null |
| ID取得失敗 | 「プロジェクトIDを取得できませんでした」 | URLパース失敗 |
| Storage読み込み失敗 | 「データの読み込みに失敗しました」 | **v3追加**: lastError検知 |
| Storage書き込み失敗 | 「データの保存に失敗しました」 | **v3追加**: lastError検知 |
| タグ追加失敗 | 「タグの追加に失敗しました」 | **v3追加**: lastError検知 |
| タグ削除失敗 | 「タグの削除に失敗しました」 | **v3追加**: lastError検知 |
| クォータ超過 | 「ストレージ容量が不足しています」 | **v3追加**: QUOTA_BYTES_PER_ITEM |

---

## 8. 実装順序（ステップ）

| ステップ | 内容 | 確認ポイント | 対応する修正 |
|----------|------|--------------|--------------|
| **Step 1** | `manifest.json`（tabs権限含む） + 空の `popup.html` | 拡張がChromeに読み込めるか | v2 P0 |
| **Step 2** | URL取得 + 安全なプロジェクトID抽出 | NotebookLMページでのみIDが取れるか | v2 P1 |
| **Step 3** | タグ保存・読込（正しいAPIシグネチャ + エラーハンドリング） | データが保存・復元されるか、エラー時にUIに表示されるか | **v3 P0, P1** |
| **Step 4** | タグ追加UI（XSS対策 + 正規化） | 候補表示、タグ追加が機能するか | v2 P1, **v3 P2** |
| **Step 5** | タグ削除UI（エラーハンドリング付き） | タグ削除が機能するか | v2 P2, **v3 P1** |
| **Step 6** | 同一タグプロジェクト一覧 | フィルタが機能するか | - |
| **Step 7** | スタイリング + エラー表示UI | 使いやすいUIか、エラーが表示されるか | **v3 P1** |

---

## 9. 開発・デバッグ手順

```bash
# 1. Chromeで読み込み
#    chrome://extensions → デベロッパーモード ON
#    「パッケージ化されていない拡張機能を読み込む」→ フォルダ選択

# 2. コード変更後
#    chrome://extensions → 「更新」ボタンをクリック

# 3. ポップアップのデバッグ
#    拡張アイコンを右クリック → 「ポップアップを検証」

# 4. Storage確認
#    DevTools → Application → Storage → Extension Storage

# 5. エラー確認（v3追加）
#    DevTools Console で chrome.runtime.lastError のログを確認
```

---

## 10. テストチェックリスト

### 機能テスト

- [ ] NotebookLMプロジェクトページでIDが正しく取得される
- [ ] 他サイトでは「NotebookLMを開いてください」と表示される
- [ ] タグ追加が正常に動作する
- [ ] タグ削除が正常に動作する
- [ ] タグ候補が表示される
- [ ] 同一タグのプロジェクト一覧が表示される
- [ ] プロジェクトリンクをクリックで遷移できる

### セキュリティテスト

- [ ] `<script>alert(1)</script>` をタグ名として入力 → XSSが発生しない
- [ ] 悪意あるURL `https://evil.com/?notebooklm.google.com/notebook/x` → IDが取得されない

### 境界値テスト

- [ ] 空のタグ名 → 追加されない
- [ ] 重複タグ → 追加されない（または警告）
- [ ] 50文字超のタグ名 → エラー表示
- [ ] 特殊文字（絵文字、記号）→ 正常に保存・表示される

### エラーハンドリングテスト（v3追加）

- [ ] ストレージ読み込み失敗時 → エラーメッセージが表示される
- [ ] ストレージ書き込み失敗時 → エラーメッセージが表示される
- [ ] オフライン状態 → 適切なエラーメッセージが表示される
- [ ] allTagsに重複・空文字がある旧データ → 正規化されて表示される

---

## 11. 既知の制限事項

| 制限 | 影響 | 将来的な対応案 |
|------|------|----------------|
| 最大500プロジェクト | sync storageのキー数上限 | chrome.storage.local への移行検討 |
| オフライン時は同期されない | 複数端末間でデータ不整合の可能性 | 同期状態のUI表示 |
| 未使用タグは自動削除されない | allTagsが肥大化する可能性 | 「未使用タグの一括削除」機能 |

---

## 次のステップ

この修正版計画で問題なければ、以下の順で実装コードを提示します。

1. **Step 1**: `manifest.json`（tabs権限含む） + 基本 `popup.html`
2. **Step 2**: `popup.js`（安全なURL解析）
3. **Step 3**: `popup.js`（正しいAPIシグネチャ + エラーハンドリング）
4. **Step 4-7**: 完全なUI + CSS + エラー表示
