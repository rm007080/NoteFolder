# 詳細実装計画：NoteFolder（修正版 v2）

> **更新履歴**: 2025-12-26 Codexレビューに基づき重大な問題を修正

---

## 0. 修正サマリ

| # | 問題 | 分類 | 修正内容 |
|---|------|------|----------|
| 1 | `tabs`権限不足 | **P0** | manifest.jsonに`tabs`権限を追加 |
| 2 | storage 8KB制限超過 | **P0** | プロジェクトごとに個別キーで保存する設計に変更 |
| 3 | 書き込みクォータ超過 | **P1** | 変更されたプロジェクトのみ書き込む |
| 4 | XSS脆弱性 | **P1** | `textContent`使用を必須化、`innerHTML`禁止 |
| 5 | URL解析の脆弱性 | **P1** | `new URL()`でホスト名を厳密検証 |
| 6 | タグ削除フロー欠落 | **P2** | 削除フローをセクション4.4に追加 |
| 7 | ストレージ初期化 | **P2** | デフォルト値による防御的読み込み |
| 8 | allTags重複・ソート | **P2** | 保存前に重複排除とソートを実施 |

---

## 1. 技術仕様

### Manifest V3 設定

```json
{
  "manifest_version": 3,
  "name": "NoteFolder",
  "version": "1.0.0",
  "description": "NotebookLMのプロジェクトをタグで管理する",
  "permissions": ["storage", "activeTab", "tabs"],
  "host_permissions": ["https://notebooklm.google.com/*"],
  "action": {
    "default_popup": "popup/popup.html",
    "default_icon": {
      "16": "icons/icon16.png",
      "48": "icons/icon48.png",
      "128": "icons/icon128.png"
    }
  },
  "icons": {
    "16": "icons/icon16.png",
    "48": "icons/icon48.png",
    "128": "icons/icon128.png"
  }
}
```

### 権限の根拠

| 権限 | 理由 | 備考 |
|------|------|------|
| `storage` | `chrome.storage.sync` でタグデータを保存・同期 | |
| `activeTab` | ポップアップ起動時に現在タブのURLを取得 | |
| `tabs` | `chrome.tabs.query()` でアクティブタブ情報を取得 | **P0修正で追加** |
| `host_permissions` | NotebookLMドメインでのみURL取得を許可 | |

---

## 2. データ構造設計（修正版）

### 2.1 ストレージスキーマ（個別キー方式）

**P0修正**: 全プロジェクトを1オブジェクトに格納する方式から、プロジェクトごとに個別キーで保存する方式に変更。

```javascript
// 保存形式（chrome.storage.sync）
{
  // プロジェクトごとに個別キー（8KB制限を回避）
  "project:abc123def456": {
    "id": "abc123def456",
    "name": "プロジェクト名（任意）",
    "tags": ["AI", "学習"],
    "updatedAt": 1703123456789
  },
  "project:xyz789ghi012": {
    "id": "xyz789ghi012",
    "name": "別のプロジェクト",
    "tags": ["リサーチ"],
    "updatedAt": 1703123456000
  },

  // 使用済みタグ一覧（入力候補用）
  "allTags": ["AI", "リサーチ", "仕事", "個人", "学習"]
}
```

### 2.2 キー命名規則

| キー | 説明 | サイズ見込み |
|------|------|--------------|
| `project:{id}` | 個別プロジェクトデータ | 約100-200バイト/件 |
| `allTags` | 全タグ一覧（ソート済み） | 最大2KB想定 |

### 2.3 sync storage制限と対策

| 制約 | 値 | 対策 |
|------|----|----|
| 総容量 | 約102KB | 個別キー方式で分散保存 |
| 1アイテム上限 | 8,192バイト | 1プロジェクト = 1キーで確実に回避 |
| キー数上限 | 512個 | 約500プロジェクトまで対応可能 |
| 書き込み頻度 | 最大120回/分 | 変更分のみ書き込みで軽減 |

---

## 3. ファイル構成と役割

```
NoteFolder/
├── manifest.json           # 拡張定義（Manifest V3）
├── popup/
│   ├── popup.html          # ポップアップUI
│   ├── popup.css           # スタイル（〜100行）
│   └── popup.js            # UIロジック + Storage操作
├── icons/
│   ├── icon16.png
│   ├── icon48.png
│   └── icon128.png
├── 要件定義..md
├── 実装計画.md             # このファイル
├── アーキテクチャ.md
├── 参照ルール.md
└── CLAUDE.md
```

### 各ファイルの責務

| ファイル | 責務 |
|----------|------|
| `manifest.json` | 権限・popup・アイコン定義 |
| `popup.html` | UI構造（タグ入力、候補リスト、プロジェクト一覧） |
| `popup.css` | 最小限のスタイリング |
| `popup.js` | ① URL解析（安全な方式）<br>② タグ保存/読込（個別キー方式）<br>③ 候補表示<br>④ フィルタ表示<br>⑤ XSS対策 |

---

## 4. 主要処理フロー

### 4.1 ポップアップ起動時

```
popup.js 起動
    ↓
chrome.tabs.query({ active: true, currentWindow: true })
    ↓
extractProjectId(tab.url) で安全にプロジェクトID抽出
    ├── 有効なID → ストレージから該当プロジェクトのタグを取得
    │               chrome.storage.sync.get([`project:${id}`, 'allTags'])
    │               ↓
    │               UIにタグ表示
    │
    └── null → 「NotebookLMのプロジェクトページを開いてください」
```

### 4.2 タグ追加フロー

```
タグ入力欄に入力
    ↓
入力中: allTags から前方一致で候補表示
    ↓
候補クリック or Enter
    ↓
バリデーション:
    - 空文字チェック
    - 重複チェック（既存タグと比較）
    ↓
chrome.storage.sync.get([`project:${id}`, 'allTags'], { allTags: [] })
    ↓
該当プロジェクトにタグ追加:
    project.tags.push(newTag)
    project.updatedAt = Date.now()
    ↓
allTags更新（重複排除 + ソート）:
    allTags = [...new Set([...allTags, newTag])].sort()
    ↓
変更分のみ保存（P1対策）:
    chrome.storage.sync.set({
      [`project:${id}`]: project,
      allTags: allTags
    })
    ↓
UI更新:
    - タグバッジ再描画（textContent使用）
    - 同一タグプロジェクト一覧更新
```

### 4.3 プロジェクトID抽出ロジック（P1修正）

**旧方式（脆弱）**:
```javascript
// NG: 悪意あるURLでもマッチする可能性
const match = url.match(/notebooklm\.google\.com\/notebook\/([a-zA-Z0-9_-]+)/);
```

**新方式（安全）**:
```javascript
function extractProjectId(url) {
  try {
    const parsedUrl = new URL(url);

    // ホスト名を厳密にチェック
    if (parsedUrl.hostname !== 'notebooklm.google.com') {
      return null;
    }

    // パスから抽出
    const pathParts = parsedUrl.pathname.split('/');
    // 期待形式: /notebook/{projectId} または /notebook/{projectId}/...
    if (pathParts[1] === 'notebook' && pathParts[2]) {
      const id = pathParts[2];
      // 英数字、ハイフン、アンダースコアのみ許可
      if (/^[a-zA-Z0-9_-]+$/.test(id)) {
        return id;
      }
    }

    return null;
  } catch (e) {
    // 無効なURL
    return null;
  }
}
```

### 4.4 タグ削除フロー（P2追加）

```
ユーザーがタグバッジの「×」をクリック
    ↓
削除対象タグを特定
    ↓
chrome.storage.sync.get(`project:${id}`)
    ↓
project.tags から該当タグを削除:
    project.tags = project.tags.filter(t => t !== targetTag)
    project.updatedAt = Date.now()
    ↓
chrome.storage.sync.set({ [`project:${id}`]: project })
    ↓
UI更新: タグバッジを再描画

※ allTags からは削除しない（他プロジェクトで使用中の可能性）
※ 将来的に「未使用タグの一括削除」機能を検討
```

### 4.5 全プロジェクト取得フロー

```javascript
// 同一タグを持つプロジェクト一覧を表示するため
async function getAllProjects() {
  return new Promise((resolve) => {
    chrome.storage.sync.get(null, (items) => {
      const projects = [];
      for (const [key, value] of Object.entries(items)) {
        if (key.startsWith('project:')) {
          projects.push(value);
        }
      }
      resolve(projects);
    });
  });
}
```

---

## 5. セキュリティ対策

### 5.1 XSS対策（P1必須）

**禁止**: `innerHTML` でユーザー入力を挿入

```javascript
// ❌ 絶対禁止
element.innerHTML = tagName;

// ✅ 必須: textContentを使用
element.textContent = tagName;

// ✅ または createElement + appendChild
function createTagBadge(tagName) {
  const badge = document.createElement('span');
  badge.className = 'tag-badge';
  badge.textContent = tagName;

  const removeBtn = document.createElement('button');
  removeBtn.textContent = '×';
  removeBtn.addEventListener('click', () => removeTag(tagName));

  badge.appendChild(removeBtn);
  return badge;
}
```

### 5.2 入力バリデーション

```javascript
function validateTagName(tag) {
  // 空文字・空白のみは拒否
  if (!tag || !tag.trim()) {
    return { valid: false, error: 'タグ名を入力してください' };
  }

  // 最大長チェック（例: 50文字）
  if (tag.length > 50) {
    return { valid: false, error: 'タグ名は50文字以内にしてください' };
  }

  return { valid: true, tag: tag.trim() };
}
```

---

## 6. ストレージ操作のベストプラクティス

### 6.1 防御的な読み込み（P2対策）

```javascript
// デフォルト値を指定して null チェックを回避
chrome.storage.sync.get(
  {
    [`project:${projectId}`]: null,
    allTags: []
  },
  (result) => {
    const project = result[`project:${projectId}`] || {
      id: projectId,
      name: '',
      tags: [],
      updatedAt: Date.now()
    };
    const allTags = result.allTags;
    // ...
  }
);
```

### 6.2 allTagsの正規化（P2対策）

```javascript
function normalizeAllTags(allTags) {
  // 重複排除 + ソート + 空文字除去
  return [...new Set(allTags)]
    .filter(tag => tag && tag.trim())
    .sort((a, b) => a.localeCompare(b, 'ja'));
}
```

---

## 7. UI設計（ワイヤーフレーム）

```
┌─────────────────────────────────┐
│ 📓 NoteFolder                   │
├─────────────────────────────────┤
│ 現在のプロジェクト:              │
│ [ID: abc123def456]              │
├─────────────────────────────────┤
│ タグを追加:                      │
│ ┌─────────────────────┐ [追加]  │
│ │ 入力...             │         │
│ └─────────────────────┘         │
│ ┌─────────────────────┐         │
│ │ AI（候補）          │         │
│ │ 学習（候補）        │         │
│ └─────────────────────┘         │
├─────────────────────────────────┤
│ このプロジェクトのタグ:          │
│ [AI ×] [学習 ×]                 │  ← 削除可能
├─────────────────────────────────┤
│ 「AI」タグのプロジェクト:        │
│ • abc123def456 (現在)           │
│ • xyz789ghi012 → 開く           │
├─────────────────────────────────┤
│ エラー表示エリア                 │  ← 追加
└─────────────────────────────────┘
```

### エラー状態の表示

| 状態 | メッセージ |
|------|------------|
| NotebookLM以外 | 「NotebookLMのプロジェクトページを開いてください」 |
| ID取得失敗 | 「プロジェクトIDを取得できませんでした」 |
| Storage読み込み失敗 | 「データの読み込みに失敗しました」 |
| タグ追加失敗 | 「タグの追加に失敗しました」 |

---

## 8. 実装順序（ステップ）

| ステップ | 内容 | 確認ポイント | 対応する修正 |
|----------|------|--------------|--------------|
| **Step 1** | `manifest.json`（tabs権限含む） + 空の `popup.html` | 拡張がChromeに読み込めるか | P0 |
| **Step 2** | URL取得 + 安全なプロジェクトID抽出 | NotebookLMページでのみIDが取れるか | P1 |
| **Step 3** | タグ保存・読込（個別キー方式） | データが保存・復元されるか | P0, P1, P2 |
| **Step 4** | タグ追加UI（XSS対策済み） | 候補表示、タグ追加が機能するか | P1 |
| **Step 5** | タグ削除UI | タグ削除が機能するか | P2 |
| **Step 6** | 同一タグプロジェクト一覧 | フィルタが機能するか | - |
| **Step 7** | スタイリング + エラー表示 | 使いやすいUIか | - |

---

## 9. 開発・デバッグ手順

```bash
# 1. Chromeで読み込み
#    chrome://extensions → デベロッパーモード ON
#    「パッケージ化されていない拡張機能を読み込む」→ フォルダ選択

# 2. コード変更後
#    chrome://extensions → 「更新」ボタンをクリック

# 3. ポップアップのデバッグ
#    拡張アイコンを右クリック → 「ポップアップを検証」

# 4. Storage確認
#    DevTools → Application → Storage → Extension Storage
```

---

## 10. テストチェックリスト

### 機能テスト

- [ ] NotebookLMプロジェクトページでIDが正しく取得される
- [ ] 他サイトでは「NotebookLMを開いてください」と表示される
- [ ] タグ追加が正常に動作する
- [ ] タグ削除が正常に動作する
- [ ] タグ候補が表示される
- [ ] 同一タグのプロジェクト一覧が表示される
- [ ] プロジェクトリンクをクリックで遷移できる

### セキュリティテスト

- [ ] `<script>alert(1)</script>` をタグ名として入力 → XSSが発生しない
- [ ] 悪意あるURL `https://evil.com/?notebooklm.google.com/notebook/x` → IDが取得されない

### 境界値テスト

- [ ] 空のタグ名 → 追加されない
- [ ] 重複タグ → 追加されない（または警告）
- [ ] 50文字超のタグ名 → エラー表示
- [ ] 特殊文字（絵文字、記号）→ 正常に保存・表示される

---

## 次のステップ

この修正版計画で問題なければ、以下の順で実装コードを提示します。

1. **Step 1**: `manifest.json`（tabs権限含む） + 基本 `popup.html`
2. **Step 2**: `popup.js`（安全なURL解析）
3. **Step 3**: `popup.js`（個別キー方式のStorage操作）
4. **Step 4-7**: 完全なUI + CSS + エラー処理
