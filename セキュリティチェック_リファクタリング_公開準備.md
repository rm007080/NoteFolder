  1) Security
                                                                                                                                 
  - 権限の最小化: manifest.json は storage と NotebookLM の host_permissions のみで、tabs/activeTab/webRequest は未使用。拡張とし
    ては比較的安全な構成。
  - データ保護: ストレージ読み書きで chrome.runtime.lastError を確認しているので、エラー時の黙殺は避けられている。
  - 追加で見たい点: 依存ライブラリなしのためサプライチェーンリスクは小さめ。今後は「DOM変更に対する耐性（NotebookLM側の更新）」が
    主な実運用リスク。

  - 大きな対象は content/content.js（約3,800行）なので、機能単位の分割方針を先に決めるのが安全です（例: storage、tags、filters、 
    ui/popover、dnd、migration）。
  - まずは“振る舞い変更なし”の整理から: 定数の集約、UI更新関数の整理、storage操作の集約、重複ロジックの関数化。
  - グローバル状態の見える化: cache / currentFilters / selectedFilterTags / currentSortType などの役割を明文化し、変更箇所を制   
    限。
  - 安全な順序: 1) ストレージ層の関数整理 → 2) タグ操作系の整理 → 3) UI描画系の整理 → 4) D&D/フィルタの整理。
  - リスクの低い改善候補: 既存の互換用 allTags の扱いを明文化、tagMeta シャードの入出力の一本化、updateUI/triggerUIRefresh の責務
    整理。

  3) 公開準備

  - README: インストール手順・対応範囲・既知制限・トラブルシュートを明確化（既に骨子あり）。
  - スクリーンショット: README.md と note記事下書き.md で参照されている画像が不足。必要枚数の整理が先。
  - プライバシー説明: 「外部送信なし」「NotebookLMのみ動作」「保存先は chrome.storage.sync」を明記。
  - 配布手順: GitHub Releases の ZIP 配布を前提に「バージョン更新の手順」を簡単に。
  - 免責/注意事項: NotebookLM側のDOM変更で動作停止する可能性を明記（既に記載あり）。

---

  Phase 1: セキュリティの細かなチェックリスト（実施結果）                                                                        

  - 権限/スコープ: manifest.json は storage と NotebookLM の host_permissions のみ、過剰権限なし（判定: OK）                     
  - 外部通信: content/content.js と popup/popup.js に外部送信の実装は見当たらず（判定: OK）
  - XSS/DOM注入: タグ表示は textContent ベース、innerHTML は固定UI文字列のみ（判定: OK）                                         
  - 入力バリデーション: validateTagName で空文字/長さ/階層区切りをチェック（判定: OK）                                           
  - データ保護/プライバシー: chrome.storage.sync にタグ・プロジェクト名を保存（判定: 要確認、公開時に明記推奨）                  
  - 拡張の境界: NotebookLM 以外で動作しない設計（判定: OK）                                                                      
                                                                                                                                 
  Phase 1: 手動テストの実施案（ブラウザ上での確認項目）                                                                          
                                                                                                                                 
  - <script>alert(1)</script> をタグ名にしても実行されない                                                                       
  - NotebookLM以外のページでUIが注入されない                                                                                     
  - タグの追加/削除/統合が意図通りに反映される                                                                                   
  - D&Dで自分自身や子孫へのドロップが無効になる                                                                                  
  - オフラインや同期遅延時の挙動（エラー表示）が破綻しない                                                                       
                                                                                                                                 
  Phase 2: リファクタリング優先順位と作業単位（計画の実施）                                                                      
  P0（安全性/整合性）

  - tagMeta の削除処理を removeTagMeta に統一し、削除キーのズレを防ぐ（content/content.js）
  - ストレージ操作のエラーハンドリングを共通関数化（get/set/removeのラッパー）し、重複を削減（content/content.js）
  - キャッシュ更新の一貫性ルールを明文化（更新順序・更新対象・UI反映タイミング）してズレを防止（content/content.js）             
  - mergeTagsInAllProjects / renameTagInAllProjects / moveTagToParent の責務整理（副作用の統一）

  P1（保守性/可読性）

  - 機能単位での分割計画（storage/tags/filters/ui/dnd/migration の6区分）                                                        
  - UI更新の入口を triggerUIRefresh に寄せ、個別更新の散在を減らす                                                               
  - 状態変数（currentFilters など）の責務表を作り、参照ルールを固定化
  - DOMセレクタの集約（NotebookLM側変更に備え、セレクタ定義を一箇所に）                                                          

  P2（UX/性能/負債低減）                                                                                                         
                                                                                                                                 
  - MutationObserverの処理量を抑えるガード（既注入確認の最適化）
  - updateInlineBadges の呼び出し集中箇所を整理（無駄な再描画を削減）                                                            
  - CSSのセクション整理（コンポーネントごとの塊に分ける方針）
  Phase 2: 完了条件（共通）

  - 既存機能の見た目/挙動が変わらないこと
  - 主要ストレージ操作の重複が減り、エラーハンドリングが一貫すること
  - 変更の影響範囲が説明可能（どの機能に触ったかを明文化）
  - 手動テスト項目が全て通ること

  Phase 3: 公開用ドキュメント（不足点の具体化）
  README の不足

  - スクリーンショットの実体が不足（screenshots/main.png 等が存在しない）
  - プライバシー/データ保存の説明が不足（chrome.storage.sync に保存される内容の明記）
  - 権限の理由説明が不足（storage と host_permissions のみである根拠）
  - 既知の制限事項の明確化（NotebookLMのDOM変更で動作しなくなる可能性）
  - 配布方法の確定（ReleasesのZIPが存在する前提の記述になっている）

  note記事の不足

  - 画像差し替えが未完（プレースホルダーのまま）
  - Releases URLの確定が必要（リンク先が未確定）
  - プライバシー説明の簡潔な明記が不足（外部送信なし/同期保存）
  - 免責の明確化が不足（公式機能ではない/DOM変更リスク）
  - サポート窓口の明記（GitHub Issues誘導を明文化）

  1. Phase1の手動テスト項目を、実施手順として短いチェックシートに落とす
  2. Phase2のP0だけを、さらに具体的な作業分割（ファイル単位）に落とす
  3. Phase3の不足点を、README/Note向けの「追記案」まで作る

  ---

    Phase2: 優先順位と作業単位（確定版）                                                                                           
                                                                                                                                 
  P0（不整合・不具合の温床）                                                                                                     
                                                                                                                                 
  - P0-1 tagMeta削除の整合                                                                                                       
    対象: content/content.js                                                                                                     
    内容: mergeTagsInAllProjects が tagMeta:${sourceTag} を remove しているが、実際はシャード形式 tagMeta:<shard>。削除が効か    
    ず“幽霊タグ”が残る恐れ。                                                                                                     
    方針: removeTagMeta(tagName) に統一 or シャード単位で削除。                                                                  
    完了条件: タグ統合後、削除済みタグが getAllTagNames() に残らない。
  - P0-2 storage.onChanged の整合
    対象: content/content.js                                                                                                     
    内容: tagMetaシャード更新時に Object.assign しているだけなので、削除されたタグがキャッシュに残る可能性。
    方針: 変更されたシャードの置き換えロジックに修正。
    完了条件: 別タブでタグ削除→他タブに即時反映される。                                                                          
  - P0-3 ストレージ操作の共通化                                                                                                  
    対象: content/content.js
    内容: get/set/remove が分散し、lastError 処理が重複。
    方針: storageGet/Set/Remove を Promise 化し統一。                                                                            
    完了条件: ストレージ操作箇所が共通関数経由になっている。                                                                     

  P1（保守性・可読性）

  - P1-1 タグ操作の責務整理
    対象: content/content.js
    内容: mergeTagsInAllProjects / renameTagInAllProjects / moveTagToParent が互いに副作用を持ち、更新順が分かりづらい。
    方針: “タグ名の変換”と“ストレージ反映”を分離。                                                                               
    完了条件: タグ変更の流れが1本化される。                                                                                      
  - P1-2 UI更新の一本化                                                                                                          
    対象: content/content.js

---

  変更まとめ（Phase2/Phase3）                                                                                                                                                                                                     
                                                                                                                                                                                                                                  
  - content/content.js                                                                                                                                                                                                            
      - P0-1: tagMeta の削除方法をシャード構造に合わせて修正
      - P0-2: 別タブ同期のUI反映を強化（focus/visibility + UI表示前同期）
      - P0-3: storageGet/Set/Remove を導入しストレージ操作を共通化                                                                                                                                                                
      - P1-1: タグ更新ロジックを共通化（置換/統合/全プロジェクト更新）                                                                                                                                                            
      - P1-2: UI更新入口を refreshProjectUI / refreshVisibleProjectUI に集約                                                                                                                                                      
      - P1-3: NotebookLMセレクタを NOTEBOOKLM_SELECTORS に集約                                                                                                                                                                    
      - P2-1: MutationObserverの負荷を軽減                                                                                                                                                                                        
  - content/content.css                                                                                                                                                                                                           
      - P2-2: セクション構成のインデックス追加（整理のみ、見た目変更なし）                                                                                                                                                        
  - README.md                                                                                                                                                                                                                     
      - 権限/プライバシー/保存データ/制限事項/トラブルシュート/アンインストールを日本語で追記                                                                                                                                     
  - note記事下書き.md                                                                                                                                                                                                             
      - 保存先/トラブルシュート/注意点/不具合報告を追記                                                                                                                                                                           

  次の作業提案（優先順）
                                                                                                                                                                                                                                  
  1. 軽い動作チェック                                                                                                                                                                                                             
      - タグ追加/削除/統合                                                                                                                                                                                                        
      - D&D（親→親、子→親）                                                                                                                                                                                                       
      - フィルタ/ソート                                                                                                                                                                                                           
      - 別タブ同期（タブ復帰で反映されるか）                                                                                                                                                                                      
  2. スクリーンショットの準備                                                                                                                                                                                                     
      - READMEとnote記事のプレースホルダーを埋める                                                                                                                                                                                
  3. 公開前の最終整理                                                                                                                                                                                                             
      - READMEの手順とReleasesリンクの整合                                                                                                                                                                                        
      - note記事のURL確定（Releases/Issues）