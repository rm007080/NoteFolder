# NoteFolder タグ表示改善 実装計画

## 対象ファイル
- `content/content.js`
- `content/content.css`

---

## 要件1: プロジェクトカードに親タグのみ表示

**修正箇所**: `createInlineBadges` (行1692-1725)

**ロジック**:
1. 全タグから親タグ名を抽出（子タグ `AI/機械学習` → 親 `AI`）
2. 重複を除去（Set使用）
3. 最大3つ表示

```javascript
function createInlineBadges(projectId, max = 3) {
  const project = getCachedProject(projectId);
  if (!project?.tags?.length) return null;

  // 全タグから親タグ名を抽出（重複除去）
  const parentTagNames = [...new Set(
    project.tags.map(tag => {
      const parts = tag.split(HIERARCHY_SEPARATOR);
      return parts[0]; // 最上位の親タグ名
    })
  )];

  // parentTagNamesを基準にバッジ表示
  parentTagNames.slice(0, max).forEach(tagName => {
    // バッジ作成（色はgetTagColor(tagName)で取得）
  });

  // +Nも parentTagNames.length を基準に計算
  if (parentTagNames.length > max) {
    more.textContent = `+${parentTagNames.length - max}`;
  }
}
```

---

## 要件2: ポップオーバー内タグ表示の改善

**現在**: 全タグを1列で表示
**変更後**: 上段に親タグ、下段に子タグを分離表示

### 2-1. showTagPopover内のupdateUI修正

```javascript
// 全タグから親タグ名を導出（カードと同じロジック）
const parentTagNames = [...new Set(
  projectTags.map(tag => tag.split(HIERARCHY_SEPARATOR)[0])
)];

// 子タグ（/を含むタグ）を抽出
const childTags = projectTags.filter(tag => tag.includes(HIERARCHY_SEPARATOR));

// 上段: 導出された親タグ一覧（ドラッグ&ドロップ可能）
// 下段: 子タグ一覧（末尾部分のみ表示、例: "機械学習"）
```

**注意**: 親タグの並び替えは、その親に属する全ての子タグの順序にも影響する

### 2-2. ドラッグ&ドロップ並び替え（親タグのみ対象）
- 各親タグバッジに`draggable="true"`設定
- 並び替え後に`reorderProjectTags`呼び出し
- **修正**: 並び替え後に`updateInlineBadges(projectId)`を呼び出す

### 2-3. 新規関数追加
```javascript
async function reorderProjectTags(projectId, fromIndex, toIndex) {
  // 親タグ配列の並び替えとストレージ保存
  // 成功後: updateInlineBadges(projectId) を呼び出し
}
```

### 2-4. CSS追加 (content.css)
```css
.nf-popover-parent-tags { margin-bottom: 8px; }
.nf-popover-child-tags { border-top: 1px solid #444; padding-top: 8px; }
.nf-tag-badge[draggable="true"] { cursor: grab; }
.nf-tag-badge.nf-dragging { opacity: 0.5; }
```

---

## 要件3: タグ選択窓の高さ拡大

**修正箇所**: content.css 行370

```css
/* 変更前 */
.nf-dropdown-list { max-height: 200px; }
/* 変更後: max-heightを削除し、JSで制御 */
.nf-dropdown-list { /* max-height削除 */ }
```

---

## 要件4: タグ選択窓リサイズ機能

### 4-1. 新規関数追加 (content.js)
```javascript
const DEFAULT_DROPDOWN_HEIGHT = 350;
async function getDropdownHeight() { /* storage読込 */ }
async function saveDropdownHeight(height) { /* storage保存 */ }
```

### 4-2. showTagDropdown修正 (行2390付近)
- **修正**: CSSの`max-height`を削除し、JSで`style.height`を直接設定
- リサイズハンドル要素を追加
- mousedown/mousemove/mouseupイベントでリサイズ処理
- 最小100px、最大600px制限
- クリーンアップ時にイベントリスナー削除

### 4-3. CSS追加 (content.css)
```css
.nf-dropdown-resize-handle {
  height: 8px;
  cursor: ns-resize;
  flex-shrink: 0;
  /* グリップ線のビジュアル */
}

.nf-dropdown-list {
  /* max-height削除 */
  overflow-y: auto;
  min-height: 100px;
  /* 注意: flex: 1は使わない。heightはJSで直接設定 */
}
```

**修正**: `flex: 1`を使用しない。`tagListContainer.style.height`で直接高さを制御

---

## 要件5: 「ルートに移動」と「タグなし」の固定表示

### 5-1. showTagDropdown構造変更

**変更後**:
```
dropdown
├── searchContainer
├── fixedOptionsContainer (固定)
│   ├── rootDropZone
│   └── untaggedItem
├── tagListContainer (スクロール)
│   └── タグリスト...
└── resizeHandle
```

### 5-2. キーボードナビゲーション対応

**問題**: 固定コンテナに移動すると`setupKeyboardNavigation`の対象外になる

**解決策**: `setupKeyboardNavigation`のセレクタを拡張
```javascript
// 変更前
setupKeyboardNavigation(tagListContainer, '.nf-dropdown-item', ...);

// 変更後: dropdown全体を対象にし、固定オプションも含める
setupKeyboardNavigation(dropdown, '.nf-dropdown-item, .nf-untagged-option, .nf-root-drop-zone', ...);
```

### 5-3. CSS追加 (content.css)
```css
.nf-tag-dropdown { display: flex; flex-direction: column; }
.nf-dropdown-fixed-options { flex-shrink: 0; border-bottom: 1px solid #444; }
/* 注意: flex: 1は使わない（要件4のリサイズと競合するため）*/
/* heightはJSで直接設定する */

/* 固定オプションにフォーカススタイル追加 */
.nf-root-drop-zone:focus,
.nf-untagged-option:focus {
  outline: 2px solid #4285f4;
  outline-offset: -2px;
}
```

---

## 実装順序

| # | 要件 | 難易度 | 備考 |
|---|------|--------|------|
| 1 | 要件3+4: 高さ+リサイズ | 中 | CSS修正とJS追加を同時に |
| 2 | 要件5: 固定表示 | 中 | 構造変更+キーボード対応 |
| 3 | 要件1: 親タグ抽出 | 低 | ロジック変更のみ |
| 4 | 要件2: ポップオーバー改善 | 高 | 親子分離+D&D |

---

## Codexレビュー対応

### 第1回レビュー
| 重要度 | 問題 | 対応 |
|--------|------|------|
| P0 | 親タグ表示仕様 | 子タグから親名を導出する方式に修正 |
| P1 | max-height整合性 | CSSのmax-height削除、JSで制御 |
| P1 | キーボード操作 | セレクタ拡張で固定オプションも対象に |
| P2 | カード更新漏れ | reorderProjectTags内でupdateInlineBadges呼び出し |

### 第2回レビュー
| 重要度 | 問題 | 対応 |
|--------|------|------|
| P1 | +Nカウンター | parentTagNames.lengthを基準に計算（コード明記済み） |
| P1 | 親セクション空問題 | ポップオーバーでも親名を導出（カードと同じロジック） |
| P1 | リサイズ不動作 | flex: 1を使わず、style.heightで直接制御 |

---

## テスト確認項目

- [ ] 子タグ`AI/機械学習`から親`AI`が導出されカードに表示
- [ ] ポップオーバーで親タグ（上段）と子タグ（下段）が分離表示
- [ ] 親タグをD&Dで並び替え可能
- [ ] 並び順がカード表示に即座に反映
- [ ] タグ選択窓が広くなっている（デフォルト350px）
- [ ] 下辺ドラッグでリサイズ可能（100-600px）
- [ ] リサイズサイズが次回も保持される
- [ ] 「ルートに移動」「タグなし」がスクロールしても固定表示
- [ ] キーボードで固定オプションにもフォーカス可能
