# NoteFolder開発 - 詳細な引き継ぎプロンプト

## プロジェクト概要

NotebookLMのプロジェクト一覧ページでタグ管理を行うChrome拡張機能（Manifest V3）を開発中。外部サーバー不要、chrome.storage.syncでデータ管理。

**プロジェクトパス**: `/mnt/c/Users/littl/app-dev/06_NoteFolder/NoteFolder`

---

## 現在の進捗状況

### 開発フェーズ: 全Phase完了 + 追加機能実装済み

| Phase | 内容 | 状態 |
|-------|------|------|
| MVP | 基本機能（タグ追加/削除/フィルター/ソート） | ✅ 完了 |
| Phase 0 | 基盤整備（マイグレーション、tagMeta、構造化フィルター） | ✅ 完了 |
| Phase 1 | タグ機能（階層化、色分け） | ✅ 完了 |
| Phase 2 | UI機能（タグ常時表示、検索、ピン留め） | ✅ 完了 |
| Phase 3 | 統計機能（タグ使用統計） | ✅ 完了 |
| 追加機能 | ドラッグ&ドロップ階層化、ドロップダウン内統計表示 | ✅ 完了 |

---

## 最新の実装内容（2025-12-30）

### 追加機能1: ドラッグ&ドロップによるタグ階層化

| 項目 | 内容 |
|------|------|
| 概要 | タグをドラッグして別のタグにドロップすると子タグになる |
| 実装箇所 | `content/content.js` 2386-2420行, 2548-2605行, 990-1093行 |
| 主要関数 | `moveTagToParent()`, `renameTagInAllProjects()` |

**動作仕様**:
- タグをドラッグして別のタグにドロップ → 子タグになる
- 子タグがある場合は子タグも一緒に移動（階層構造維持）
- 「📁 ルートに移動」ゾーンにドロップ → ルートレベルに戻る
- 自分自身や子孫へのドロップは無効（循環参照防止）

### 追加機能2: タグドロップダウン内の使用統計表示

| 項目 | 内容 |
|------|------|
| 概要 | 各タグの右側に使用回数を `(3)` 形式で表示 |
| 実装箇所 | `content/content.js` 2368-2376行, 2529-2533行 |
| CSS | `.nf-tag-count` (content.css 415-422行) |

---

## ファイル構成

```
NoteFolder/
├── manifest.json              # Content Script設定済み
├── content/
│   ├── content.js             # メインロジック（約2800行）
│   └── content.css            # スタイル（約860行）
├── popup/
│   ├── popup.html             # 設定画面（タグ使用統計表示）
│   ├── popup.css              # ポップアップスタイル
│   └── popup.js               # タグ統計計算・表示ロジック
├── icons/
│   ├── icon16.png
│   ├── icon48.png
│   └── icon128.png
├── README.md                  # 公開用
├── LICENSE                    # MITライセンス
├── 機能拡張実装計画_v3.md      # 詳細な実装仕様
├── TAKEOVER.md                # この引き継ぎドキュメント
└── CLAUDE.md                  # プロジェクト指示書
```

---

## データ構造

```javascript
{
  // プロジェクトデータ
  "project:{uuid}": {
    "id": "uuid",
    "name": "プロジェクト名",           // DOMから取得
    "tags": ["AI/機械学習", "学習"],    // 階層化対応（/区切り）
    "pinned": false,                     // ピン留め
    "updatedAt": 1703123456789
  },

  // タグメタデータ（シャード分割）
  "tagMeta:A": {
    "AI": { "color": null },
    "AI/機械学習": { "color": "#34a853" }
  },
  "tagMeta:学": {
    "学習": { "color": "#4285f4" }
  },

  // マイグレーションバージョン
  "_migrationVersion": 3,

  // 後方互換性
  "allTags": ["AI", "AI/機械学習", "学習"]
}
```

---

## 主要関数一覧（最新）

### タグ移動関数（追加機能）

| 関数 | 行番号 | 役割 |
|------|--------|------|
| `moveTagToParent(sourceTag, targetParent)` | 990-1045 | タグを別の親の下に移動（子タグも一緒） |
| `renameTagInAllProjects(oldTag, newTag)` | 1047-1093 | 全プロジェクトでタグ名をリネーム |

### 統計計算（ドロップダウン内）

| 関数 | 行番号 | 役割 |
|------|--------|------|
| `usageCounts` 計算 | 2368-2376 | renderTagList内でタグ使用回数を集計 |

### 階層タグ関数

| 関数 | 役割 |
|------|------|
| `parseHierarchicalTag(tag)` | タグをパーツ配列に分割 |
| `getParentTag(tag)` | 親タグを取得 |
| `getChildTags(parentTag, allTags)` | 子タグを取得 |
| `getTagDepth(tag)` | タグの深度を取得 |
| `ensureParentTagExists(tag)` | 親タグ自動作成 |

### tagMetaシャーディング

| 関数 | 役割 |
|------|------|
| `getShardKey(tagName)` | タグ名からシャードキーを取得 |
| `loadTagMetaFromItems(items)` | ストレージからtagMetaを読み込み |
| `saveTagMeta(tagName, data)` | tagMetaを保存 |
| `removeTagMeta(tagName)` | tagMetaから削除 |

---

## 現在のUI構成

```
[タグドロップダウン]
┌────────────────────────────┐
│ 🔍 タグを検索...           │
├────────────────────────────┤
│ 📁 ルートに移動            │  ← ドロップゾーン
├────────────────────────────┤
│ 📂 タグなし                │
│ ● AI              (3)  ×  │  ← ドラッグ可能、統計表示
│   └ ● テスト      (1)  ×  │  ← 子タグ（インデント）
│ ● 健康            (3)  ×  │
│ ● 読書            (3)  ×  │
└────────────────────────────┘
```

---

## テスト方法

### 拡張機能の更新

1. `chrome://extensions`
2. NoteFolderの「更新」ボタン
3. NotebookLMページをリロード

### 動作確認

1. https://notebooklm.google.com/ を開く
2. F12 → Console でエラーがないことを確認
3. タグドロップダウンで各タグ右側に`(数字)`が表示される
4. タグをドラッグして別のタグにドロップ → 子タグになる
5. 階層タグを「ルートに移動」にドロップ → ルートに戻る
6. 拡張アイコンクリック → ポップアップでタグ統計表示確認

---

## 注意事項

### 禁止操作（CLAUDE.mdより）

- `git push`, `git commit` は実行しない
- `.env*`, 秘密鍵ファイルは読み書きしない

### 実装上の注意

- **XSS対策**: ユーザー入力は必ず`textContent`で表示
- **lastErrorチェック**: 全storage操作で`chrome.runtime.lastError`を確認
- **個別キー方式**: プロジェクトは`project:{id}`形式で個別保存
- **マイグレーションバージョン**: 現在v3

### 参照ドキュメント

| ファイル | 内容 |
|----------|------|
| `機能拡張実装計画_v3.md` | 詳細な実装仕様（Phase 0-3） |
| `CLAUDE.md` | 開発ガイド・禁止操作 |
| `アーキテクチャ.md` | システム設計図 |

---

## 次のタスク候補

1. **リリース準備**: README更新、スクリーンショット追加
2. **バグ修正**: 発見された問題の修正
3. **機能追加**: ユーザーからの要望に応じて

---

**最終更新**: 2025-12-30
**実装担当**: Claude Opus 4.5
**ステータス**: 全機能実装完了 - テスト・リリース準備可能
