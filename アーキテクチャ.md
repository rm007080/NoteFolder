# アーキテクチャ設計書：NoteFolder

本ドキュメントは、NoteFolder Chrome拡張機能の技術的な設計思想と構造を記述する。

---

## 1. システム概要

### 1.1 アーキテクチャ図

```
┌─────────────────────────────────────────────────────────────┐
│                      User (NotebookLM)                      │
└────────────────────────┬────────────────────────────────────┘
                         │ クリック
                         ↓
┌─────────────────────────────────────────────────────────────┐
│                   Chrome Extension Icon                      │
└────────────────────────┬────────────────────────────────────┘
                         │ ポップアップ起動
                         ↓
┌─────────────────────────────────────────────────────────────┐
│                       Popup UI Layer                         │
│  ┌────────────┐  ┌────────────┐  ┌──────────────┐          │
│  │ popup.html │←→│ popup.css  │←→│  popup.js    │          │
│  └────────────┘  └────────────┘  └──────┬───────┘          │
└────────────────────────────────────────┼────────────────────┘
                                          │
                    ┌─────────────────────┼─────────────────────┐
                    │                     │                     │
                    ↓                     ↓                     ↓
         ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐
         │  chrome.tabs API │  │ chrome.storage   │  │   Data Layer     │
         │                  │  │     .sync API    │  │                  │
         │ - query()        │  │ - get()          │  │ projects: {}     │
         │ - URL取得        │  │ - set()          │  │ allTags: []      │
         └──────────────────┘  └──────────────────┘  └──────────────────┘
                    │                     │                     │
                    └─────────────────────┼─────────────────────┘
                                          │
                                          ↓
                              ┌──────────────────────┐
                              │  Google Account Sync │
                              │   (自動同期)          │
                              └──────────────────────┘
```

### 1.2 設計原則

| 原則 | 理由 |
|------|------|
| **Manifest V3準拠** | 最新のChrome拡張機能標準に従う |
| **外部依存ゼロ** | サーバー不要、ユーザーデータは端末内のみで管理 |
| **最小権限原則** | 必要最小限の権限のみを要求 |
| **段階的機能提供** | MVPに集中し、過剰な機能は実装しない |
| **同期優先** | chrome.storage.syncで複数デバイス対応 |

---

## 2. コンポーネント設計

### 2.1 manifest.json（拡張定義層）

**役割**: Chrome拡張機能のメタデータ、権限、エントリポイントを定義

**主要設定**:
```json
{
  "manifest_version": 3,
  "permissions": ["storage", "activeTab"],
  "host_permissions": ["https://notebooklm.google.com/*"],
  "action": {
    "default_popup": "popup/popup.html"
  }
}
```

**権限の最小化**:
- `storage`: chrome.storage.syncへのアクセス（タグデータ保存）
- `activeTab`: ポップアップ起動時の現在タブURL取得のみ
- `host_permissions`: NotebookLMドメインのみに制限

### 2.2 popup.html（UI構造層）

**役割**: ポップアップのDOM構造を定義

**主要要素**:
- プロジェクトID表示エリア
- タグ入力フォーム
- タグ候補リスト（datalist or カスタムドロップダウン）
- 現在のプロジェクトのタグ表示
- 同一タグを持つプロジェクト一覧

**設計思想**: セマンティックHTML、アクセシビリティ考慮

### 2.3 popup.css（スタイル層）

**役割**: UIの視覚的デザイン

**設計方針**:
- 最小限のスタイリング（80行以内）
- Googleのマテリアルデザインを参考
- NotebookLMのUIトーンと調和
- レスポンシブ不要（ポップアップサイズ固定）

### 2.4 popup.js（ロジック層）

**役割**: UIとChrome API、データ層の橋渡し

**主要責務**:
1. **URL解析**: 現在タブのURLからプロジェクトIDを抽出
2. **Storage操作**: タグデータの読み書き
3. **UI更新**: ユーザー操作に応じた動的表示
4. **イベントハンドリング**: フォーム送信、タグクリックなど

---

## 3. データフロー

### 3.1 ポップアップ起動フロー

```
1. ユーザーが拡張アイコンをクリック
   ↓
2. popup.html が読み込まれ、popup.js が実行開始
   ↓
3. chrome.tabs.query({ active: true, currentWindow: true })
   ↓
4. 現在タブのURL取得
   ↓
5. URL解析: notebooklm.google.com/notebook/{projectId} か判定
   ├─ YES → projectId 抽出
   │    ↓
   │  6. chrome.storage.sync.get('projects')
   │    ↓
   │  7. 該当プロジェクトのタグ配列を取得
   │    ↓
   │  8. UIに表示
   │
   └─ NO → 「NotebookLMを開いてください」メッセージ表示
```

### 3.2 タグ追加フロー

```
1. ユーザーがタグ入力欄に文字入力
   ↓
2. allTags から前方一致で候補を絞り込み
   ↓
3. 候補リストをリアルタイム表示
   ↓
4. ユーザーが候補をクリック or Enter
   ↓
5. chrome.storage.sync.get(['projects', 'allTags'])
   ↓
6. データ更新:
   - projects[projectId].tags に新タグを追加
   - allTags に新タグを追加（重複なし）
   - updatedAt を現在時刻に更新
   ↓
7. chrome.storage.sync.set({ projects, allTags })
   ↓
8. UI更新:
   - タグバッジを再描画
   - 同一タグを持つプロジェクト一覧を更新
```

### 3.3 タグ削除フロー

```
1. ユーザーがタグバッジの「×」をクリック
   ↓
2. chrome.storage.sync.get('projects')
   ↓
3. projects[projectId].tags から該当タグを削除
   ↓
4. chrome.storage.sync.set({ projects })
   ↓
5. UI更新: タグバッジを再描画
```

---

## 4. データ層設計

### 4.1 ストレージスキーマ

```javascript
{
  // プロジェクトとタグの紐づけ
  "projects": {
    "abc123def456": {
      "id": "abc123def456",            // プロジェクトID（NotebookLMのURL由来）
      "name": "プロジェクト名",          // 任意（将来的に手動編集可能にする可能性）
      "tags": ["AI", "学習"],           // タグ配列
      "updatedAt": 1703123456789       // 最終更新タイムスタンプ
    }
  },

  // 使用済みタグ一覧（入力候補用）
  "allTags": ["AI", "学習", "リサーチ", "仕事", "個人"]
}
```

### 4.2 chrome.storage.sync の制約と対策

| 制約 | 対策 |
|------|------|
| 総容量: 約100KB | 数百プロジェクトまで対応可能（1プロジェクト約100-200バイト想定） |
| 1アイテム: 最大8KB | `projects` が肥大化したら、将来的に分割も検討 |
| 書き込み頻度制限 | タグ追加・削除時のみ書き込み（頻繁な更新は発生しない） |
| 同期遅延 | 端末間の同期は非同期、ユーザーに遅延を説明する必要なし |

### 4.3 プロジェクトID抽出ロジック

```javascript
function extractProjectId(url) {
  // NotebookLMのURL形式: https://notebooklm.google.com/notebook/{projectId}
  const match = url.match(/notebooklm\.google\.com\/notebook\/([a-zA-Z0-9_-]+)/);
  return match ? match[1] : null;
}
```

**想定される形式**:
- `https://notebooklm.google.com/notebook/abc123def456`
- `https://notebooklm.google.com/notebook/abc123def456/note/xyz`

**非対応**:
- NotebookLMのホームページ（プロジェクト一覧）
- 他のGoogleサービス

---

## 5. セキュリティ設計

### 5.1 権限の最小化

| 権限 | 用途 | リスク軽減策 |
|------|------|--------------|
| `storage` | タグデータ保存 | 他の拡張機能からは隔離されている |
| `activeTab` | 現在タブのURL取得 | ユーザー操作（ポップアップ起動）時のみ |
| `host_permissions` | NotebookLMドメイン限定 | 他サイトでは動作しない |

**不要な権限**:
- ❌ `<all_urls>`: 全サイトアクセス不要
- ❌ `tabs`: タブ一覧取得不要（activeTabで十分）
- ❌ `webRequest`: ネットワーク監視不要

### 5.2 データ保護

- **外部送信なし**: タグデータは chrome.storage.sync のみに保存
- **Google同期**: Googleアカウントの暗号化に依存
- **ローカル閲覧不可**: 他の拡張機能やWebサイトからはアクセス不可

### 5.3 XSS対策

**脅威**: ユーザーが入力したタグ名に `<script>` などが含まれる可能性

**対策**:
```javascript
// NG例: innerHTML（XSSリスク）
element.innerHTML = tagName;

// OK例: textContent（安全）
element.textContent = tagName;

// または createElement + appendChild
const badge = document.createElement('span');
badge.textContent = tagName;
```

### 5.4 プロジェクトID検証

**脅威**: 不正なURLから抽出されたIDが悪意あるコードを含む

**対策**:
```javascript
function isValidProjectId(id) {
  // 英数字、ハイフン、アンダースコアのみ許可
  return /^[a-zA-Z0-9_-]+$/.test(id);
}
```

---

## 6. UI/UX設計

### 6.1 ポップアップサイズ

- **推奨サイズ**: 幅 400px × 高さ 500px
- **理由**: タグ候補とプロジェクト一覧を同時表示可能な最小サイズ

### 6.2 ユーザーフロー

```
[拡張アイコンクリック]
        ↓
[ポップアップ表示]
        ↓
┌─────────────────────────┐
│ 現在のプロジェクト: ... │  ← プロジェクトID確認
│ タグを追加: [入力欄]    │  ← タグ入力
│   候補: AI, 学習...     │  ← 候補選択
│                         │
│ このプロジェクトのタグ: │
│ [AI ×] [学習 ×]         │  ← タグ削除可能
│                         │
│ 「AI」タグのプロジェクト:│
│ • abc123 (現在)         │
│ • xyz789 → 開く         │  ← クリックで遷移
└─────────────────────────┘
```

### 6.3 エラー状態の処理

| 状態 | 表示内容 |
|------|----------|
| NotebookLM以外のページ | 「NotebookLMのプロジェクトページを開いてください」 |
| プロジェクトID取得失敗 | 「プロジェクトIDを取得できませんでした」 |
| Storage読み込み失敗 | 「データの読み込みに失敗しました」 |

---

## 7. 拡張性の考慮

### 7.1 将来的な機能拡張の可能性

| 機能 | 実装の容易性 | 備考 |
|------|--------------|------|
| タグの色分け | 容易 | storage に `color` プロパティ追加 |
| タグの使用頻度表示 | 容易 | `usageCount` を集計 |
| タグのリネーム | 中程度 | 全プロジェクトのタグを一括更新 |
| エクスポート/インポート | 容易 | JSON形式でダウンロード/アップロード |
| タグの階層化 | 困難 | データ構造の大幅な変更が必要 |

### 7.2 モジュール分割の検討

**現在**: popup.js に全ロジックを統合（MVP優先）

**将来的な分割案**:
```
popup/
├── popup.html
├── popup.css
├── popup.js           # UIイベントハンドリング
└── modules/
    ├── storage.js     # chrome.storage.sync操作
    ├── urlParser.js   # URL解析
    └── tagManager.js  # タグ管理ロジック
```

---

## 8. 非機能要件との対応

| 非機能要件 | アーキテクチャ上の対応 |
|------------|------------------------|
| 外部サーバー不使用 | chrome.storage.sync のみで完結 |
| NotebookLM内部API非依存 | URLパターンのみを利用 |
| 外部送信なし | ネットワーク権限を要求しない |
| UI最小限 | ポップアップのみ、コンテンツスクリプト不使用 |

---

## 9. パフォーマンス設計

### 9.1 想定負荷

- **プロジェクト数**: 最大500個を想定
- **タグ数**: 最大100種類を想定
- **1プロジェクトあたりのタグ数**: 平均3-5個

### 9.2 最適化戦略

| 処理 | 最適化手法 |
|------|------------|
| タグ候補表示 | 前方一致検索（O(n)、nは全タグ数） |
| プロジェクト一覧フィルタ | インデックスなし（MVPでは許容） |
| Storage読み込み | 必要なキーのみ取得 |

---

## 10. テスト戦略

### 10.1 手動テスト項目

1. **NotebookLMページでの動作**
   - プロジェクトID正常取得
   - タグ追加・削除
   - 候補表示

2. **他ページでの動作**
   - エラーメッセージ表示

3. **Storage同期**
   - 別PCでの同期確認

4. **エッジケース**
   - タグ名が空白
   - 重複タグ追加
   - 特殊文字（絵文字、記号）

### 10.2 自動テストの検討（将来）

MVPでは手動テストのみ。将来的にはJestなどでユニットテスト導入を検討。

---

**最終更新**: 2025-12-26
