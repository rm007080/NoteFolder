# アーキテクチャ設計書：NoteFolder（v3更新版）

本ドキュメントは、NoteFolder Chrome拡張機能の技術的な設計思想と構造を記述する。

> **更新履歴**: 2025-12-26 v3修正版の実装計画に基づき更新

---

## 1. システム概要

### 1.1 アーキテクチャ図

```
┌─────────────────────────────────────────────────────────────┐
│                      User (NotebookLM)                      │
└────────────────────────┬────────────────────────────────────┘
                         │ クリック
                         ↓
┌─────────────────────────────────────────────────────────────┐
│                   Chrome Extension Icon                      │
└────────────────────────┬────────────────────────────────────┘
                         │ ポップアップ起動
                         ↓
┌─────────────────────────────────────────────────────────────┐
│                       Popup UI Layer                         │
│  ┌────────────┐  ┌────────────┐  ┌──────────────┐          │
│  │ popup.html │←→│ popup.css  │←→│  popup.js    │          │
│  └────────────┘  └────────────┘  └──────┬───────┘          │
└────────────────────────────────────────┼────────────────────┘
                                          │
                    ┌─────────────────────┼─────────────────────┐
                    │                     │                     │
                    ↓                     ↓                     ↓
         ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐
         │  chrome.tabs API │  │ chrome.storage   │  │   Data Layer     │
         │                  │  │     .sync API    │  │                  │
         │ - query()        │  │ - get()          │  │ project:{id}     │
         │ - URL取得        │  │ - set()          │  │ allTags: []      │
         │                  │  │ + lastError      │  │                  │
         └──────────────────┘  └──────────────────┘  └──────────────────┘
                    │                     │                     │
                    └─────────────────────┼─────────────────────┘
                                          │
                                          ↓
                              ┌──────────────────────┐
                              │  Google Account Sync │
                              │   (自動同期)          │
                              └──────────────────────┘
```

### 1.2 設計原則

| 原則 | 理由 |
|------|------|
| **Manifest V3準拠** | 最新のChrome拡張機能標準に従う |
| **外部依存ゼロ** | サーバー不要、ユーザーデータは端末内のみで管理 |
| **最小権限原則** | 必要最小限の権限のみを要求 |
| **段階的機能提供** | MVPに集中し、過剰な機能は実装しない |
| **同期優先** | chrome.storage.syncで複数デバイス対応 |
| **エラー耐性** | 全storage操作でlastErrorをチェック（v3追加） |

---

## 2. コンポーネント設計

### 2.1 manifest.json（拡張定義層）

**役割**: Chrome拡張機能のメタデータ、権限、エントリポイントを定義

**主要設定** (v3更新):
```json
{
  "manifest_version": 3,
  "permissions": ["storage", "activeTab", "tabs"],
  "host_permissions": ["https://notebooklm.google.com/*"],
  "action": {
    "default_popup": "popup/popup.html"
  }
}
```

**権限の最小化**:
- `storage`: chrome.storage.syncへのアクセス（タグデータ保存）
- `activeTab`: ポップアップ起動時の現在タブURL取得のみ
- **`tabs`**: chrome.tabs.query()に必要（**v2 P0修正で追加**）
- `host_permissions`: NotebookLMドメインのみに制限

### 2.2 popup.html（UI構造層）

**役割**: ポップアップのDOM構造を定義

**主要要素**:
- プロジェクトID表示エリア
- タグ入力フォーム
- タグ候補リスト（datalist or カスタムドロップダウン）
- 現在のプロジェクトのタグ表示
- 同一タグを持つプロジェクト一覧
- **エラー表示エリア**（v3追加）

**設計思想**: セマンティックHTML、アクセシビリティ考慮

### 2.3 popup.css（スタイル層）

**役割**: UIの視覚的デザイン

**設計方針**:
- 最小限のスタイリング（100行程度）
- Googleのマテリアルデザインを参考
- NotebookLMのUIトーンと調和
- レスポンシブ不要（ポップアップサイズ固定）

### 2.4 popup.js（ロジック層）

**役割**: UIとChrome API、データ層の橋渡し

**主要責務** (v3更新):
1. **URL解析**: 現在タブのURLからプロジェクトIDを抽出（`new URL()`で安全に）
2. **Storage操作**: タグデータの読み書き（個別キー方式 + lastErrorチェック）
3. **UI更新**: ユーザー操作に応じた動的表示（XSS対策済み）
4. **イベントハンドリング**: フォーム送信、タグクリックなど
5. **エラーハンドリング**: 全storage操作でエラーを検知・表示

---

## 3. データフロー

### 3.1 ポップアップ起動フロー（v3更新）

```
1. ユーザーが拡張アイコンをクリック
   ↓
2. popup.html が読み込まれ、popup.js が実行開始
   ↓
3. chrome.tabs.query({ active: true, currentWindow: true }, (tabs) => { ... })
   ↓
4. 現在タブのURL取得
   ↓
5. extractProjectId(url) で安全にID抽出（new URL()使用）
   ├─ YES → projectId 抽出
   │    ↓
   │  6. chrome.storage.sync.get(
   │       { [`project:${id}`]: null, allTags: [] },  // デフォルト値
   │       (result) => {
   │         if (chrome.runtime.lastError) {  // エラーチェック
   │           showError('データの読み込みに失敗しました');
   │           return;
   │         }
   │         const allTags = normalizeAllTags(result.allTags);  // 正規化
   │         // UIに表示
   │       }
   │     )
   │
   └─ NO → 「NotebookLMのプロジェクトページを開いてください」
```

### 3.2 タグ追加フロー（v3更新）

```
1. ユーザーがタグ入力欄に文字入力
   ↓
2. allTags から前方一致で候補を絞り込み
   ↓
3. 候補リストをリアルタイム表示
   ↓
4. ユーザーが候補をクリック or Enter
   ↓
5. バリデーション（空文字、重複チェック）
   ↓
6. chrome.storage.sync.get(
     { [`project:${id}`]: null, allTags: [] },
     (result) => {
       if (chrome.runtime.lastError) { /* エラー処理 */ }

       // データ更新
       const project = result[`project:${id}`] || createNewProject(id);
       project.tags.push(newTag);
       project.updatedAt = Date.now();

       // allTags正規化
       let allTags = [...result.allTags, newTag];
       allTags = normalizeAllTags(allTags);

       // 保存
       chrome.storage.sync.set(
         { [`project:${id}`]: project, allTags: allTags },
         () => {
           if (chrome.runtime.lastError) { /* エラー処理 */ }
           // UI更新（textContentで安全に）
         }
       )
     }
   )
```

### 3.3 タグ削除フロー（v3更新）

```
1. ユーザーがタグバッジの「×」をクリック
   ↓
2. chrome.storage.sync.get(
     { [`project:${id}`]: null },
     (result) => {
       if (chrome.runtime.lastError) { /* エラー処理 */ }

       // タグ削除
       project.tags = project.tags.filter(t => t !== targetTag);
       project.updatedAt = Date.now();

       // 保存
       chrome.storage.sync.set(
         { [`project:${id}`]: project },
         () => {
           if (chrome.runtime.lastError) { /* エラー処理 */ }
           // UI更新
         }
       )
     }
   )
```

---

## 4. データ層設計

### 4.1 ストレージスキーマ（v3更新）

**個別キー方式**（v2 P0修正で変更）:

```javascript
{
  // プロジェクトごとに個別キー（8KB制限を回避）
  "project:abc123def456": {
    "id": "abc123def456",
    "name": "プロジェクト名（任意）",
    "tags": ["AI", "学習"],
    "updatedAt": 1703123456789
  },
  "project:xyz789ghi012": {
    "id": "xyz789ghi012",
    "name": "別のプロジェクト",
    "tags": ["リサーチ"],
    "updatedAt": 1703123456000
  },

  // 使用済みタグ一覧（入力候補用・ソート済み）
  "allTags": ["AI", "リサーチ", "仕事", "個人", "学習"]
}
```

**キー命名規則**:
- `project:{id}`: 個別プロジェクトデータ（約100-200バイト/件）
- `allTags`: 全タグ一覧（最大2KB想定）

### 4.2 chrome.storage.sync の制約と対策（v3更新）

| 制約 | 値 | 対策 |
|------|----|----|
| 総容量 | 約102KB | 個別キー方式で分散保存 |
| 1アイテム上限 | 8,192バイト | 1プロジェクト = 1キーで確実に回避 |
| キー数上限 | 512個 | 約500プロジェクトまで対応可能 |
| 書き込み頻度 | 最大120回/分 | 変更分のみ書き込みで軽減 |
| 同期遅延 | 端末間で数秒 | ユーザーに遅延を説明する必要なし |

### 4.3 プロジェクトID抽出ロジック（v3更新）

**安全な方式**（v2 P1修正で変更）:

```javascript
function extractProjectId(url) {
  try {
    const parsedUrl = new URL(url);

    // ホスト名を厳密にチェック
    if (parsedUrl.hostname !== 'notebooklm.google.com') {
      return null;
    }

    // パスから抽出
    const pathParts = parsedUrl.pathname.split('/');
    // 期待形式: /notebook/{projectId} または /notebook/{projectId}/...
    if (pathParts[1] === 'notebook' && pathParts[2]) {
      const id = pathParts[2];
      // 英数字、ハイフン、アンダースコアのみ許可
      if (/^[a-zA-Z0-9_-]+$/.test(id)) {
        return id;
      }
    }

    return null;
  } catch (e) {
    // 無効なURL
    return null;
  }
}
```

**想定される形式**:
- `https://notebooklm.google.com/notebook/abc123def456`
- `https://notebooklm.google.com/notebook/abc123def456/note/xyz`

**非対応**:
- NotebookLMのホームページ（プロジェクト一覧）
- 他のGoogleサービス
- 悪意あるURL（`https://evil.com/?notebooklm.google.com/notebook/x`）

### 4.4 データ正規化（v3追加）

```javascript
function normalizeAllTags(allTags) {
  // 重複排除 + ソート + 空文字除去
  return [...new Set(allTags)]
    .filter(tag => tag && tag.trim())
    .sort((a, b) => a.localeCompare(b, 'ja'));
}
```

**実行タイミング**:
1. **読み込み直後**: 旧データのクリーンアップ
2. **保存前**: 新規追加時の正規化

---

## 5. セキュリティ設計

### 5.1 権限の最小化（v3更新）

| 権限 | 用途 | リスク軽減策 |
|------|------|--------------|
| `storage` | タグデータ保存 | 他の拡張機能からは隔離されている |
| `activeTab` | 現在タブのURL取得 | ユーザー操作（ポップアップ起動）時のみ |
| **`tabs`** | chrome.tabs.query()に必要 | **v2 P0修正で追加** |
| `host_permissions` | NotebookLMドメイン限定 | 他サイトでは動作しない |

**不要な権限**:
- ❌ `<all_urls>`: 全サイトアクセス不要
- ❌ `webRequest`: ネットワーク監視不要

### 5.2 データ保護

- **外部送信なし**: タグデータは chrome.storage.sync のみに保存
- **Google同期**: Googleアカウントの暗号化に依存
- **ローカル閲覧不可**: 他の拡張機能やWebサイトからはアクセス不可

### 5.3 XSS対策（v2 P1修正）

**脅威**: ユーザーが入力したタグ名に `<script>` などが含まれる可能性

**対策**（必須）:
```javascript
// ❌ 絶対禁止: innerHTML（XSSリスク）
element.innerHTML = tagName;

// ✅ 必須: textContent（安全）
element.textContent = tagName;

// ✅ または createElement + appendChild
const badge = document.createElement('span');
badge.className = 'tag-badge';
badge.textContent = tagName;

const removeBtn = document.createElement('button');
removeBtn.textContent = '×';
removeBtn.addEventListener('click', () => removeTag(tagName));

badge.appendChild(removeBtn);
```

### 5.4 入力バリデーション

```javascript
function validateTagName(tag) {
  // 空文字・空白のみは拒否
  if (!tag || !tag.trim()) {
    return { valid: false, error: 'タグ名を入力してください' };
  }

  // 最大長チェック（例: 50文字）
  if (tag.length > 50) {
    return { valid: false, error: 'タグ名は50文字以内にしてください' };
  }

  return { valid: true, tag: tag.trim() };
}
```

---

## 6. エラーハンドリング設計（v3新設）

### 6.1 chrome.runtime.lastError チェック（v3 P1修正）

**全storage操作で必須**:

```javascript
// 読み込み時
chrome.storage.sync.get(defaults, (result) => {
  if (chrome.runtime.lastError) {
    console.error('Storage read error:', chrome.runtime.lastError.message);
    showError('データの読み込みに失敗しました');
    return;
  }
  // 正常時の処理
});

// 書き込み時
chrome.storage.sync.set(data, () => {
  if (chrome.runtime.lastError) {
    console.error('Storage write error:', chrome.runtime.lastError.message);
    showError('データの保存に失敗しました');
    return;
  }
  // 正常時の処理
});
```

### 6.2 エラー表示UIパターン

```javascript
function showError(message) {
  const errorArea = document.getElementById('error-area');
  errorArea.textContent = message;  // XSS対策
  errorArea.style.display = 'block';

  // 5秒後に自動非表示
  setTimeout(() => {
    errorArea.style.display = 'none';
  }, 5000);
}
```

### 6.3 エラー状態の処理

| 状態 | メッセージ | トリガー |
|------|------------|----------|
| NotebookLM以外のページ | 「NotebookLMのプロジェクトページを開いてください」 | extractProjectId() → null |
| ID取得失敗 | 「プロジェクトIDを取得できませんでした」 | URLパース失敗 |
| Storage読み込み失敗 | 「データの読み込みに失敗しました」 | lastError検知 |
| Storage書き込み失敗 | 「データの保存に失敗しました」 | lastError検知 |
| クォータ超過 | 「ストレージ容量が不足しています」 | QUOTA_BYTES_PER_ITEM |

---

## 7. UI/UX設計

### 7.1 ポップアップサイズ

- **推奨サイズ**: 幅 400px × 高さ 500px
- **理由**: タグ候補とプロジェクト一覧を同時表示可能な最小サイズ

### 7.2 ユーザーフロー

```
[拡張アイコンクリック]
        ↓
[ポップアップ表示]
        ↓
┌─────────────────────────┐
│ 現在のプロジェクト: ... │  ← プロジェクトID確認
│ タグを追加: [入力欄]    │  ← タグ入力
│   候補: AI, 学習...     │  ← 候補選択
│                         │
│ このプロジェクトのタグ: │
│ [AI ×] [学習 ×]         │  ← タグ削除可能
│                         │
│ 「AI」タグのプロジェクト:│
│ • abc123 (現在)         │
│ • xyz789 → 開く         │  ← クリックで遷移
│                         │
│ ⚠️ エラーエリア         │  ← v3追加
└─────────────────────────┘
```

---

## 8. 拡張性の考慮

### 8.1 将来的な機能拡張の可能性

| 機能 | 実装の容易性 | 備考 |
|------|--------------|------|
| タグの色分け | 容易 | storage に `color` プロパティ追加 |
| タグの使用頻度表示 | 容易 | `usageCount` を集計 |
| タグのリネーム | 中程度 | 全プロジェクトのタグを一括更新 |
| エクスポート/インポート | 容易 | JSON形式でダウンロード/アップロード |
| タグの階層化 | 困難 | データ構造の大幅な変更が必要 |

### 8.2 モジュール分割の検討

**現在**: popup.js に全ロジックを統合（MVP優先）

**将来的な分割案**:
```
popup/
├── popup.html
├── popup.css
├── popup.js           # UIイベントハンドリング
└── modules/
    ├── storage.js     # chrome.storage.sync操作
    ├── urlParser.js   # URL解析
    ├── tagManager.js  # タグ管理ロジック
    └── errorHandler.js # エラーハンドリング（v3追加）
```

---

## 9. 非機能要件との対応

| 非機能要件 | アーキテクチャ上の対応 |
|------------|------------------------|
| 外部サーバー不使用 | chrome.storage.sync のみで完結 |
| NotebookLM内部API非依存 | URLパターンのみを利用 |
| 外部送信なし | ネットワーク権限を要求しない |
| UI最小限 | ポップアップのみ、コンテンツスクリプト不使用 |
| エラー耐性 | 全storage操作でlastErrorをチェック（v3追加） |

---

## 10. パフォーマンス設計

### 10.1 想定負荷

- **プロジェクト数**: 最大500個を想定（キー数上限）
- **タグ数**: 最大100種類を想定
- **1プロジェクトあたりのタグ数**: 平均3-5個

### 10.2 最適化戦略

| 処理 | 最適化手法 |
|------|------------|
| タグ候補表示 | 前方一致検索（O(n)、nは全タグ数） |
| プロジェクト一覧フィルタ | インデックスなし（MVPでは許容） |
| Storage読み込み | 必要なキーのみ取得（個別キー方式） |
| allTags正規化 | 読み込み直後と保存前に実行 |

---

## 11. テスト戦略

### 11.1 手動テスト項目

1. **NotebookLMページでの動作**
   - プロジェクトID正常取得
   - タグ追加・削除
   - 候補表示

2. **他ページでの動作**
   - エラーメッセージ表示

3. **Storage同期**
   - 別PCでの同期確認

4. **エッジケース**
   - タグ名が空白
   - 重複タグ追加
   - 特殊文字（絵文字、記号）

5. **エラーハンドリング**（v3追加）
   - Storage読み込み失敗時
   - Storage書き込み失敗時
   - オフライン状態

6. **セキュリティ**（v3追加）
   - XSS攻撃（`<script>alert(1)</script>`をタグ名として入力）
   - 悪意あるURL（`https://evil.com/?notebooklm.google.com/notebook/x`）

### 11.2 自動テストの検討（将来）

MVPでは手動テストのみ。将来的にはJestなどでユニットテスト導入を検討。

---

## 12. 既知の制限事項（v3追加）

| 制限 | 影響 | 将来的な対応案 |
|------|------|----------------|
| 最大500プロジェクト | sync storageのキー数上限 | chrome.storage.local への移行検討 |
| オフライン時は同期されない | 複数端末間でデータ不整合の可能性 | 同期状態のUI表示 |
| 未使用タグは自動削除されない | allTagsが肥大化する可能性 | 「未使用タグの一括削除」機能 |

---

**最終更新**: 2025-12-26（v3更新版）
**対応実装計画**: 実装計画.md v3修正版
